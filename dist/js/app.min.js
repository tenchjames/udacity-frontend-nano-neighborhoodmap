var initialLocations=[{locationTypes:["lodging"],locationName:"Courtyard Nashville Downtown"},{locationTypes:["bar","night_club"],locationName:"The Stage on Broadway"},{locationTypes:["bar","night_club"],locationName:"Tootsies Orchid Lounge"},{locationTypes:["bar","night_club"],locationName:"Tequila Cowboy"},{locationTypes:["food","bar","restaurant"],locationName:"Rock Bottom Nashville"}],FOUR_SQUARE_URL="https://api.foursquare.com/v2/venues/",FOUR_SQUARE_CLIENT_ID="5HFALNIUYZ31OHEDLIQZWPNQCE2ODS5ZSA2TCD3D0MRNXQVA",FOUR_SQUARE_CLIENT_SECRET="ECISSMB3KL5V1S4H31SLVNUEUJAQH43EHNUPAFDOZIMOW512",FOUR_SQUARE_VERSION="20150110",FOUR_SQUARE_M="foursquare",map,sv,panorama,service,searchBox,downtownNashville=new google.maps.LatLng(36.1606405,-86.7762455),initMap=function(a){var b={center:a,zoom:16,disableDefaultUI:!0},c=new google.maps.LatLngBounds(new google.maps.LatLng(35.1606405,-87.7762455),new google.maps.LatLng(37.1606405,-85.7762455)),d={bounds:c};map=new google.maps.Map(document.getElementById("map"),b),service=new google.maps.places.PlacesService(map),map.controls[google.maps.ControlPosition.LEFT_TOP].push(document.getElementById("locationListContainer"));var e=document.getElementById("pac-input");map.controls[google.maps.ControlPosition.TOP_LEFT].push(document.getElementById("searchContainer")),searchBox=new google.maps.places.SearchBox(e,d),map.controls[google.maps.ControlPosition.RIGHT_TOP].push(document.getElementById("pano")),sv=new google.maps.StreetViewService;var f={position:downtownNashville,pov:{heading:90,pitch:0}};panorama=new google.maps.StreetViewPanorama(document.getElementById("pano"),f),map.setStreetView(panorama)},NeighborhoodLocation=function(a){this.markerOpen=ko.observable(!1),this.receivedFourSquareUpdate=ko.observable(!1),this.locationTypes=ko.observableArray(a.locationTypes),this.locationName=ko.observable(a.locationName),this.formattedAddress=ko.observable(a.formattedAddress),this.vicinity=ko.observable(),this.latitude="",this.longitude="",this.panoRadius=10,this.fourSquareHereNowSummary=ko.observable(""),this.fourSquarePrimaryCategory=ko.observable(""),this.fourSquareCheckInCount=ko.observable(""),this.fourSquareError=ko.observable(""),this.locationNameDiv=ko.computed(function(){return this.locationName()&&""!==this.locationName()?'<div class="infoWindowSection"><h4>'+this.locationName()+"</h4></div>":'<div class="infoWindowSection"><h4>Getting Foursquare data...</h4></div>'},this),this.fourSquarePrimaryCategoryDiv=ko.computed(function(){return'<div class="infoWindowSection"><p>Category: <span class="primaryCategory">'+this.fourSquarePrimaryCategory()+"</span></p></div>"},this),this.vicinityDiv=ko.computed(function(){return'<div class="infoWindowSection"><p>Address: <span class="address">'+this.vicinity()+"</span></p></div>"},this),this.fourSquareHereNowDiv=ko.computed(function(){var a="hereNow";return"Nobody here"===this.fourSquareHereNowSummary()&&(a="nobodyHereNow"),'<div class="infoWindowSection"><p>Here now: <span class="'+a+'">'+this.fourSquareHereNowSummary()+"</span></p></div>"},this),this.fourSquareCheckInCountDiv=ko.computed(function(){return'<div class="infoWindowSection"><p>Foursquare checkins: <span class="haveCheckedIn">'+this.fourSquareCheckInCount()+"</span></p></div>"},this),this.infoWindowDiv=ko.computed(function(){return this.fourSquareError().length>0?'<div class="infoWindowContainer">'+this.locationNameDiv()+this.vicinityDiv()+this.fourSquareError()+"</div>":'<div class="infoWindowContainer">'+this.locationNameDiv()+this.fourSquarePrimaryCategoryDiv()+this.vicinityDiv()+this.fourSquareHereNowDiv()+this.fourSquareCheckInCountDiv()+"</div>"},this)};NeighborhoodLocation.prototype={init:function(){var a={locationName:this.locationName(),locationTypes:this.locationTypes()};this.searchForPlaceMarker(a),this.infoWindow=new google.maps.InfoWindow({content:this.infoWindowDiv()})},createMapMarker:function(a){var b=this;if(void 0!==a[0].vicinity&&b.vicinity(a[0].vicinity.split(",")[0]),this.latitude=a[0].geometry.location.lat(),this.longitude=a[0].geometry.location.lng(),this.geometryLocation=a[0].geometry.location,b.marker=new google.maps.Marker({map:map,position:a[0].geometry.location,title:a[0].name}),void 0!==a[0].icon){var c=new google.maps.MarkerImage(a[0].icon,null,null,null,new google.maps.Size(25,25));b.marker.setIcon(c)}google.maps.event.addListener(b.marker,"click",function(){b.markerOpen(!b.markerOpen())}),b.markerOpen()&&b.infoWindow.open(map,b.marker),b.setFourSquareInfo()},searchForPlaceMarker:function(a){var b={};b.location=downtownNashville,b.radius=1200,a.locationKeyword&&""!==a.locationKeyword&&(b.keyword=a.locationKeyword),a.locationName&&""!==a.locationName&&(b.name=a.locationName),a.locationTypes&&a.locationTypes.length>0&&(b.type=a.locationTypes),service.nearbySearch(b,this.addPlaceCallback.bind(this))},addPlaceCallback:function(a,b){b===google.maps.places.PlacesServiceStatus.OK?this.addPlace(a):this.locationName="Error getting google places data, please check your internet connection and try again"},addPlace:function(a){void 0!==a.name&&(this.locationName=a.name),void 0!==a.types&&a.types>0&&(this.locationTypes=a.types),this.createMapMarker(a)},getFourSquareInfo:function(){return $.ajax({url:FOUR_SQUARE_URL+"search",type:"GET",dataType:"jsonp",contentType:"application/json",data:{client_id:FOUR_SQUARE_CLIENT_ID,client_secret:FOUR_SQUARE_CLIENT_SECRET,ll:this.latitude+","+this.longitude,query:this.locationName(),radius:50,v:FOUR_SQUARE_VERSION,m:FOUR_SQUARE_M}})},setFourSquareInfo:function(){var a=this;a.getFourSquareInfo().done(function(b){var c,d,e=b.response.venues,f=0,g=0,h=0,i=a.vicinity().split(""),j=[];if(e.length>1)for(c=0;c<e.length;c+=1){for(j=void 0!==e[c].location&&void 0!==e[c].location.address?e[c].location.address.split(""):"",h=0,d=0;d<i.length&&d<j.length&&i[d]===j[d];d+=1)h+=1;h>g&&(f=c,g=h)}if(a.fourSquareHereNowSummary(void 0!==e[f].hereNow.summary?e[f].hereNow.summary:"Data unavailable from Foursquare"),a.fourSquareCheckInCount(void 0!==e[f].stats.checkinsCount?e[f].stats.checkinsCount:"Data unavailable from Foursquare"),void 0!==e[f].categories&&e[f].categories.length>0){for(c=0;c<e[f].categories.length;c+=1)if(e[f].categories[c].primary===!0){a.fourSquarePrimaryCategory(e[f].categories[c].name);break}}else a.fourSquarePrimaryCategory("Data unavailable from Foursquare");a.receivedFourSquareUpdate(!0)}).fail(function(){a.fourSquareError('<span class="error">Error getting data from Foursquare, please be sure you are connected to the internet</span>'),a.fourSquareCheckInCount(""),a.fourSquarePrimaryCategory(""),a.fourSquareHereNowSummary(""),a.receivedFourSquareUpdate(!0)})}};var ViewModel=function(){var a=this;a.allLocations=ko.observableArray([]),a.subscribeToMapClick=function(b){b.markerOpen.subscribe(function(c){c?a.setCurrentLocation(b):a.closeInfoWindow(b)})},a.subscribeToFourSquareUpdate=function(b){b.receivedFourSquareUpdate.subscribe(function(c){c&&b.infoWindow&&(b.infoWindow.setContent(b.infoWindowDiv()),b.markerOpen()&&a.getPanoramaImage())})},a.deletePlace=function(b){void 0!==b.marker&&b.marker.setMap(null),a.allLocations.remove(b)},a.addPlace=function(b){a.allLocations.push(b),a.subscribeToMapClick(b),a.subscribeToFourSquareUpdate(b),b.markerOpen(!0)},a.closeInfoWindows=function(){for(var b=a.allLocations().length,c=0;b>c;c+=1)a.allLocations()[c].infoWindow&&a.allLocations()[c]!==a.currentLocation()&&a.allLocations()[c].markerOpen(!1)},a.closeInfoWindow=function(a){a.infoWindow&&!a.markerOpen()&&a.infoWindow.close()},a.currentLocation=ko.observable(),a.setCurrentLocation=function(b){a.currentLocation(b),a.closeInfoWindows(),void 0!==b.infoWindow&&void 0!==b.marker&&(b.infoWindow.setContent(a.currentLocation().infoWindowDiv()),b.infoWindow.open(map,b.marker)),b.geometryLocation&&a.getPanoramaImage()},a.toggleInfoWindow=function(a){a.markerOpen(!a.markerOpen())},a.getPanoramaImage=function(){sv.getPanoramaByLocation(a.currentLocation().geometryLocation,a.currentLocation().panoRadius,a.processSVData)},a.processSVData=function(b,c){if(c===google.maps.StreetViewStatus.OK){$("#panoError").removeClass("unhide"),panorama.setPano(b.location.pano);var d=google.maps.geometry.spherical.computeHeading(b.location.latLng,a.currentLocation().geometryLocation);panorama.setPov({heading:d,pitch:0}),panorama.setVisible(!0)}else c===google.maps.StreetViewStatus.ZERO_RESULTS?(a.currentLocation().panoRadius+=40,a.getPanoramaImage()):$("#panoError").addClass("unhide")};for(var b=0;b<initialLocations.length;b+=1){var c=new NeighborhoodLocation(initialLocations[b]);c.init(),a.allLocations.push(c),a.subscribeToMapClick(c),a.subscribeToFourSquareUpdate(c)}google.maps.event.addListener(searchBox,"places_changed",function(){var b=searchBox.getPlaces();if(0!==b.length){var c=new NeighborhoodLocation({locationName:b[0].name,locationTypes:b[0].types});c.init(),a.addPlace(c)}}),a.setCurrentLocation(a.allLocations()[0])};google.maps.event.addDomListener(window,"load",initMap(downtownNashville)),setTimeout(function(){ko.applyBindings(new ViewModel)},1e3);